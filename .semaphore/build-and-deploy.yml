version: v1.0
name: Root pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "Build and push images"
    task:
      env_vars:
        # TODO: change as required
        - name: AWS_DEFAULT_REGION
          value: eu-west-1
        - name: ECR_REGISTRY_FRONT
          value: 945151552117.dkr.ecr.eu-west-1.amazonaws.com/lambdacademy-front
        - name: ECR_REGISTRY_BACK
          value: 945151552117.dkr.ecr.eu-west-1.amazonaws.com/lambdacademy-back
      secrets:
        - name: AWS
      prologue:
        commands:
          # Install the most up-to-date AWS cli
          - sudo pip install awscli
          - checkout
          # ecr get-login outputs a login command, so execute that with bash
          - aws ecr get-login --no-include-email | bash
      jobs:
        - name: Build and push front
          commands:
            - docker build -t front -f deploy/front.Dockerfile .
            - docker tag front "${ECR_REGISTRY_FRONT}:latest"
            - docker push "${ECR_REGISTRY_FRONT}:latest"
        - name: Build and push back
          commands:
            - docker build -t back -f deploy/back.Dockerfile .
            - docker tag back "${ECR_REGISTRY_BACK}:latest"
            - docker push "${ECR_REGISTRY_BACK}:latest"
  - name: "Deploy"
    task:
      secrets:
        - name: SERVER
      prologue:
        commands:
          - checkout
          - chmod 400 /home/semaphore/SERVER_KEY
      jobs:
        - name: "Deploy on server via SSH"
          commands:
            - ssh -o StrictHostKeyChecking=no -i /home/semaphore/SERVER_KEY $SERVER_USER@$SERVER_HOST "aws ecr get-login --no-include-email | bash"
            - scp -o StrictHostKeyChecking=no -i /home/semaphore/SERVER_KEY -r deploy/* $SERVER_USER@$SERVER_HOST:/home/lambda
            - ssh -o StrictHostKeyChecking=no -i /home/semaphore/SERVER_KEY $SERVER_USER@$SERVER_HOST "docker-compose pull"
            - ssh -o StrictHostKeyChecking=no -i /home/semaphore/SERVER_KEY $SERVER_USER@$SERVER_HOST "docker-compose -f /home/lambda/docker-compose.yml up -d"